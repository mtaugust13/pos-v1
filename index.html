<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <style>
      .item-card {
        min-width: 420px !important;
        max-width: 460px !important;
        min-height: 160px !important;
        max-height: 180px !important;
        box-sizing: border-box;
      }
      .item-right-box input, .item-right-box button {
        box-sizing: border-box;
      }
      .item-right-box {
        width: 150px;
        min-width: 140px;
        max-width: 180px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        justify-content: center;
        gap: 8px;
      }
      .item-note-input {
        width: 100%;
        font-size: 15px;
        padding: 6px 8px;
        border-radius: 6px;
        border: 1.5px solid #D4AF37;
        background: #0B1929;
        color: #D4AF37;
      }
      .item-amount-input {
        width: 60px;
        font-size: 18px;
        padding: 6px 4px;
        border-radius: 6px;
        border: 1.5px solid #D4AF37;
        background: #0B1929;
        color: #D4AF37;
        text-align: center;
      }
      .item-plus-btn {
        font-size: 18px;
        padding: 8px 16px;
        background: #D4AF37;
        border-radius: 6px;
        margin-left: 4px;
        color: #0B1929;
        font-weight: bold;
      }
      .item-btn {
        font-size: 20px;
        padding: 12px 24px;
        margin-top: 8px;
      }
    </style>
  <meta charset="UTF-8">
  <title>八月十三</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- iOS 加入主畫面 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0B1929;
      color: #D4AF37;
      height: 100vh;
      overflow: hidden;
    }

    /* Login Screen */
    #login {
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #0B1929;
    }

    .login-box {
      text-align: center;
      width: 100%;
      max-width: 400px;
      padding: 20px;
    }

    .login-box h2 {
      margin-bottom: 20px;
      font-size: 28px;
      color: #D4AF37;
    }

    .login-box input {
      width: 100%;
      font-size: 24px;
      padding: 16px;
      margin-top: 12px;
      text-align: center;
      border-radius: 8px;
      border: 2px solid #D4AF37;
      background: #1a1a2e;
      color: #D4AF37;
    }

    .login-box button {
      width: 100%;
      font-size: 22px;
      padding: 16px;
      margin-top: 20px;
      border-radius: 10px;
      border: none;
      background: #D4AF37;
      color: #0B1929;
      cursor: pointer;
      font-weight: bold;
    }

    .login-box button:active {
      opacity: 0.8;
    }

    /* Main App Layout - 3 Columns */
    #app {
      display: none;
      width: 100%;
      height: 100vh;
      display: flex;
      gap: 0;
    }

    /* Left Section - Cart (25%) */
    .cart-section {
      width: 25%;
      background: #1a1a2e;
      border-right: 2px solid #1a2d4a;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      margin-top: 52px;
    }

    /* Top Header Row - 1st Row */
    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 52px;
      background: #1a3050;
      border-bottom: 2px solid #D4AF37;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 0 24px;
      gap: 12px;
      z-index: 99;
    }

    .cart-header {
      padding: 16px;
      background: #1a3050;
      border-bottom: 2px solid #D4AF37;
      font-size: 20px;
      font-weight: bold;
      color: #D4AF37;
    }

    .cart-items {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .cart-item {
      background: #1a3050;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      gap: 8px;
      border: 1px solid #1a2d4a;
    }

    .cart-item-name {
      flex: 1;
      text-align: left;
      min-width: 80px;
      color: #D4AF37;
    }

    .cart-item-qty-input {
      width: 70px;
      padding: 8px 10px;
      background: #1a1a2e;
      color: #D4AF37;
      border: 2px solid #D4AF37;
      border-radius: 6px;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.2s;
    }

    .cart-item-qty-input:focus {
      outline: none;
      background: #1a3050;
      box-shadow: 0 0 8px rgba(212, 175, 55, 0.5);
    }

    .cart-item-qty-input::-webkit-outer-spin-button,
    .cart-item-qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .cart-item-qty-input[type=number] {
      -moz-appearance: textfield;
    }

    .cart-item-qty-container {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .cart-qty-btn {
      background: #D4AF37;
      color: #0B1929;
      border: none;
      border-radius: 4px;
      width: 32px;
      height: 32px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .cart-qty-btn:active {
      background: #B8860B;
      transform: scale(0.95);
    }

    .cart-item-price {
      text-align: right;
      min-width: 60px;
      font-weight: bold;
      color: #D4AF37;
    }

    .cart-item-remove {
      background: #C41E3A;
      color: #E8E8E8;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
    }

    .cart-item-remove:active {
      opacity: 0.8;
    }

    .cart-footer {
      padding: 16px;
      background: #1a3050;
      border-top: 2px solid #D4AF37;
    }

    .total-amount {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 18px;
      font-weight: bold;
      color: #D4AF37;
    }

    .total-amount .amount {
      font-size: 28px;
      color: #D4AF37;
    }

    .cart-actions {
      display: flex;
      gap: 8px;
    }

    .cart-actions button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      color: #D4AF37;
    }

    .btn-purchase {
      background: #D4AF37;
      color: #0B1929;
      font-weight: bold;
    }
    .btn-purchase:active {
      background: #B8860B;
      opacity: 0.9;
    }

    .btn-clear {
      background: #1a2d4a;
      color: #D4AF37;
      font-weight: bold;
    }

    .btn-clear:active {
      opacity: 0.8;
    }

    .btn-logout {
      background: #C41E3A;
      color: #D4AF37;
    }

    .btn-logout:active {
      opacity: 0.8;
    }

    /* Middle Section - Sales Items (50%) */
    .items-section {
      width: 50%;
      background: #0B1929;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border-right: 2px solid #1a2d4a;
      margin-top: 52px;
    }

    /* Right Section - Purchased List (25%) */
    .purchased-section-column {
      width: 25%;
      background: #1a1a2e;
      border-left: 2px solid #1a2d4a;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      margin-top: 52px;
    }

    .purchased-section-column .purchased-header {
      padding: 16px;
      background: #1a3050;
      border-bottom: 2px solid #D4AF37;
      font-size: 20px;
      font-weight: bold;
      color: #D4AF37;
    }

    .purchased-section-column .purchased-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .items-header {
      padding: 16px;
      background: #1a3050;
      border-bottom: 2px solid #D4AF37;
      font-size: 20px;
      font-weight: bold;
      color: #D4AF37;
    }

    .items-grid {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: stretch;
    }

    .item-card {
      background: #1a3050;
      border-radius: 8px;
      padding: 8px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      text-align: left;
      gap: 8px;
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
      border: 2px solid #D4AF37;
      width: 100%;
      box-sizing: border-box;
    }

    .item-card:active {
      background: #D4AF37;
      transform: scale(0.98);
      color: #0B1929;
    }

    .item-image {
      width: 100px;
      height: 100px;
      object-fit: contain;
      border-radius: 6px;
      flex-shrink: 0;
    }

    .item-details {
      flex: 1;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 6px;
      width: 100%;
    }

    .item-name {
      font-size: 14px;
      font-weight: bold;
      margin: 0;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .item-price {
      font-size: 16px;
      color: #D4AF37;
      font-weight: bold;
      margin: 0;
      text-align: left;
      margin-left: 12px;
    }

    .item-btn {
      background: #D4AF37;
      color: #0B1929;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .item-btn:active {
      opacity: 0.8;
    }

    /* Scrollbar Styling */
    .cart-items::-webkit-scrollbar {
      width: 6px;
    }

    .items-grid::-webkit-scrollbar {
      display: none;
    }

    .items-grid {
      scrollbar-width: none; /* Firefox */
    }

    .cart-items::-webkit-scrollbar-track {
      background: #0B1929;
    }

    .cart-items::-webkit-scrollbar-thumb {
      background: #D4AF37;
      border-radius: 3px;
    }

    @media (max-width: 1024px) {
      .item-card {
        height: 90px;
        padding: 10px;
      }

      .item-image {
        width: 70px;
        height: 70px;
      }

      .item-name {
        font-size: 14px;
      }

      .item-price {
        font-size: 16px;
      }
    }
  </style>
</head>

<body>
      <!-- Custom Modal for Purchase Success -->
      <div id="purchaseSuccessModal" style="display:none;position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;">
        <div style="background:#232323;padding:32px 24px;border-radius:16px;box-shadow:0 4px 32px #0008;min-width:280px;text-align:center;">
          <div style="font-size:22px;font-weight:bold;margin-bottom:18px;color:#fff;">結帳成功！</div>
          <div style="display:flex;gap:18px;justify-content:center;">
            <button id="purchaseSuccessOkBtn" style="padding:12px 28px;font-size:18px;border-radius:8px;border:none;background:orange;color:#fff;cursor:pointer;">確定</button>
          </div>
        </div>
      </div>
    <!-- Custom Modal for Purchase Confirmation -->
    <div id="purchaseModal" style="display:none;position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;">
      <div style="background:#1a3050;padding:32px 24px;border-radius:16px;box-shadow:0 4px 32px #0008;min-width:280px;text-align:center;border:2px solid #D4AF37;">
        <div style="font-size:22px;font-weight:bold;margin-bottom:18px;color:#D4AF37;">確定要結帳嗎？</div>
        <div style="display:flex;gap:18px;justify-content:center;">
          <button id="purchaseCancelBtn" style="padding:12px 28px;font-size:18px;border-radius:8px;border:none;background:#1a2d4a;color:#D4AF37;cursor:pointer;">取消</button>
          <button id="purchaseConfirmBtn" style="padding:12px 28px;font-size:18px;border-radius:8px;border:none;background:#D4AF37;color:#0B1929;cursor:pointer;font-weight:bold;">結帳</button>
        </div>
      </div>
    </div>
  <!-- Custom Modal for Clear Cart Confirmation -->
  <div id="clearCartModal" style="display:none;position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;">
    <div style="background:#1a3050;padding:32px 24px;border-radius:16px;box-shadow:0 4px 32px #0008;min-width:280px;text-align:center;border:2px solid #D4AF37;">
      <div style="font-size:22px;font-weight:bold;margin-bottom:18px;color:#D4AF37;">確定要清空購物車？</div>
      <div style="display:flex;gap:18px;justify-content:center;">
        <button id="clearCartCancelBtn" style="padding:12px 28px;font-size:18px;border-radius:8px;border:none;background:#1a2d4a;color:#D4AF37;cursor:pointer;">取消</button>
        <button id="clearCartConfirmBtn" style="padding:12px 28px;font-size:18px;border-radius:8px;border:none;background:#C41E3A;color:#D4AF37;cursor:pointer;">清空</button>
      </div>
    </div>
  </div>

  <!-- Custom Alert Modal -->
  <div id="alertModal" style="display:none;position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;">
    <div style="background:#1a3050;padding:32px 24px;border-radius:16px;box-shadow:0 4px 32px #0008;min-width:280px;text-align:center;border:2px solid #D4AF37;">
      <div id="alertMessage" style="font-size:20px;font-weight:bold;margin-bottom:18px;color:#D4AF37;"></div>
      <div style="display:flex;gap:18px;justify-content:center;">
        <button id="alertOkBtn" style="padding:12px 28px;font-size:18px;border-radius:8px;border:none;background:#D4AF37;color:#0B1929;cursor:pointer;font-weight:bold;">確定</button>
      </div>
    </div>
  </div>

  <!-- Custom Modal for Today's Sales Summary -->
  <div id="todaysSalesModal" style="display:none;position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;">
    <div style="background:#1a3050;padding:24px;border-radius:16px;box-shadow:0 4px 32px #0008;min-width:400px;max-height:70vh;display:flex;flex-direction:column;border:2px solid #D4AF37;">
      <div style="font-size:22px;font-weight:bold;margin-bottom:12px;color:#D4AF37;text-align:center;">今日銷售統計</div>
      <div style="border-bottom:2px solid #1a2d4a;margin-bottom:12px;padding-bottom:12px;">
        <div style="font-size:14px;color:#B0B0B0;text-align:right;">日期: <span id="todayDateDisplay" style="color:#D4AF37;"></span></div>
      </div>
      
      <!-- Scrollable container: Total Amount + Summary + Detail List -->
      <div id="todaysSalesListContainer" style="flex:1;overflow-y:auto;padding-right:6px;">
        <div style="text-align:center;color:#999;">載入中...</div>
      </div>
      
      <div style="display:flex;gap:12px;justify-content:center;margin-top:16px;">
        <button id="todaysSalesCloseBtn" style="padding:12px 28px;font-size:16px;border-radius:8px;border:none;background:#1a2d4a;color:#D4AF37;cursor:pointer;">關閉</button>
      </div>
    </div>
  </div>

  <!-- 登入畫面 -->
  <div id="login">
    <div class="login-box">
      <h2>請輸入 PIN</h2>
      <input
        type="password"
        id="pin"
        inputmode="numeric"
        placeholder="****"
        onkeypress="if(event.key==='Enter') login()"
      >
      <button onclick="login()">登入</button>
    </div>
  </div>

  <!-- 主畫面 - iPad 雙欄版 -->
  <div id="app">
    <!-- Top Header Row (1st Row) - Light Gray Background -->
    <div class="top-header">
      <button id="todaysSalesBtn" class="btn-sales" style="min-width:90px;font-size:18px;padding:12px 20px;height:52px;display:flex;align-items:center;justify-content:center;line-height:28px;background:#D4AF37;color:#0B1929;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">今日銷售</button>
      <button id="logoutTopRight" class="btn-logout" style="min-width:90px;font-size:18px;padding:12px 20px;height:52px;display:flex;align-items:center;justify-content:center;line-height:28px;background:#C41E3A;color:#D4AF37;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">登出</button>
    </div>
    <!-- 左欄 (30%) - 購物車 -->
    <div class="cart-section">
      <div class="cart-header">購物車</div>
      
      <div class="cart-items" id="cartItems">
        <!-- 購物車項目會動態加入這裡 -->
      </div>

      <div class="cart-footer">
        <div class="total-amount">
          <span>總金額:</span>
          <span class="amount" id="totalAmount">$0</span>
        </div>
        <div class="cart-actions">
          <button class="btn-clear" onclick="clearCart()">清空購物車</button>
          <button class="btn-purchase" onclick="purchaseCart()" style="background:#D4AF37;color:#0B1929;">結帳</button>
        </div>
      </div>
    </div>

    <!-- 中欄 (50%) - 銷售商品 -->
    <div class="items-section">
      <div class="items-header">商品列表</div>
      <div class="items-grid" id="itemsGrid">
        <!-- 商品卡片會動態加入這裡 -->
      </div>
    </div>

    <!-- 右欄 (25%) - 已購清單 -->
    <div class="purchased-section-column">
      <div class="purchased-header">已購清單</div>
      <div class="purchased-list" id="purchasedList">
        <!-- 已購項目會動態加入這裡 -->
      </div>
    </div>
  </div>

  <style>
    .purchased-section {
      background: #181818;
      border-top: 2px solid #333;
      padding: 12px 16px 16px 16px;
      min-height: 80px;
      max-height: 220px;
      overflow-y: auto;
      display: none;
    }
    .purchased-header {
      font-size: 18px;
      font-weight: bold;
      color: #FFD700;
      margin-bottom: 8px;
    }
    .purchased-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .purchased-item {
      background: #1a3050;
      border-radius: 6px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 15px;
      color: #D4AF37;
      box-shadow: 0 2px 8px #0002;
      border: 1px solid #1a2d4a;
    }
    .purchased-item .cross-btn {
      color: #C41E3A;
      font-size: 20px;
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 12px;
      padding: 0 6px;
      line-height: 1;
    }
  </style>

  <script>
        // Move logout logic to top right button
        document.addEventListener('DOMContentLoaded', function() {
          var logoutBtn = document.getElementById('logoutTopRight');
          if (logoutBtn) logoutBtn.onclick = logout;
          
          // Setup today's sales button
          var todaysSalesBtn = document.getElementById('todaysSalesBtn');
          if (todaysSalesBtn) todaysSalesBtn.onclick = showTodaysSales;
          
          // Setup close button for sales modal
          var closeBtn = document.getElementById('todaysSalesCloseBtn');
          if (closeBtn) closeBtn.onclick = function() {
            document.getElementById('todaysSalesModal').style.display = 'none';
          };
        });

        // Function to show today's sales summary
        async function showTodaysSales() {
          const token = localStorage.getItem("sessionToken");
          if (!token) {
            showAlert('未登入');
            return;
          }
          
          // Show loading state
          document.getElementById('todaysSalesModal').style.display = 'flex';
          document.getElementById('todaysSalesListContainer').innerHTML = '<div style="text-align:center;color:#999;">載入中...</div>';
          
          // Set today's date display
          const today = new Date();
          const dateStr = today.getFullYear() + '-' + 
                         String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(today.getDate()).padStart(2, '0');
          document.getElementById('todayDateDisplay').textContent = dateStr;
          
          try {
            // Fetch today's sales from API
            const res = await fetch(API_URL + '?todaySales=1', {
              method: 'GET',
              headers: {
                'x-session-token': token
              }
            });
            
            const data = await res.json();
            
            if (data.status === 'ok' && data.sales && Array.isArray(data.sales)) {
              let totalAmount = 0;
              const salesList = data.sales;
              
              // Step 1: Group by item name and calculate counts/totals
              const itemSummary = {};
              salesList.forEach((item) => {
                const itemName = item.name || '商品';
                const itemPrice = item.price || 0;
                totalAmount += itemPrice;
                
                if (!itemSummary[itemName]) {
                  itemSummary[itemName] = {
                    count: 0,
                    totalPrice: 0,
                    name: itemName
                  };
                }
                itemSummary[itemName].count += 1;
                itemSummary[itemName].totalPrice += itemPrice;
              });
              
              // Step 2: Build total amount display
              let html = '<div style="background:#1a1a2e;border-radius:6px;padding:16px;margin-bottom:12px;border:2px solid #D4AF37;text-align:center;">';
              html += '<div style="font-size:14px;color:#B0B0B0;margin-bottom:6px;">總金額</div>';
              html += '<div style="font-size:32px;color:#D4AF37;font-weight:bold;">$' + totalAmount + '</div>';
              html += '</div>';
              
              // Step 3: Build summary HTML (grouped items)
              html += '<div style="background:#1a1a2e;border-radius:6px;padding:12px;margin-bottom:12px;border:1px solid #1a2d4a;">';;
              html += '<div style="font-size:14px;font-weight:bold;color:#D4AF37;margin-bottom:10px;">商品統計</div>';
              
              Object.values(itemSummary).forEach((summary) => {
                html += `<div style="background:#2a2a2a;border-radius:6px;padding:10px 12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">`
                  + `<div style="flex:1;color:#D4AF37;font-size:14px;">`
                    + `<div>${summary.name} × ${summary.count}</div>`
                  + `</div>`
                  + `<div style="color:#D4AF37;font-weight:bold;font-size:14px;">$${summary.totalPrice}</div>`
                + `</div>`;
              });
              
              html += '</div>';
              
              // Step 4: Build detail list HTML
              html += '<div style="border-top:1px solid #1a2d4a;padding-top:12px;">';;
              html += '<div style="font-size:14px;font-weight:bold;color:#B0B0B0;margin-bottom:10px;">購買明細</div>';
              
              salesList.forEach((item, index) => {
                const itemPrice = item.price || 0;
                const itemName = item.name || '商品 ' + (index + 1);
                const itemNote = item.note ? ` (${item.note})` : '';
                const timestamp = item.timestamp ? item.timestamp.split(' ').slice(1).join(' ') : '';
                
                html += `<div style="background:#2a2a2a;border-radius:6px;padding:10px 12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">`
                  + `<div style="flex:1;color:#D4AF37;font-size:13px;">`
                    + `<div>${itemName}${itemNote}</div>`
                    + `<div style="color:#999;font-size:12px;margin-top:2px;">${timestamp}</div>`
                  + `</div>`
                  + `<div style="color:#D4AF37;font-weight:bold;font-size:13px;">$${itemPrice}</div>`
                + `</div>`;
              });
              
              html += '</div>';
              
              document.getElementById('todaysSalesListContainer').innerHTML = html || '<div style="text-align:center;color:#999;">今天還沒有銷售</div>';
            } else {
              document.getElementById('todaysSalesListContainer').innerHTML = '<div style="text-align:center;color:#999;">今天還沒有銷售</div>';
            }
          } catch (e) {
            console.error('Error fetching today sales:', e);
            document.getElementById('todaysSalesListContainer').innerHTML = '<div style="text-align:center;color:#C41E3A;">無法載入資料</div>';
          }
        }

        // Purchase function: show custom modal for confirmation
        function purchaseCart() {
          if (!cart.length) {
            showAlert('購物車是空的');
            return;
          }
          document.getElementById('purchaseModal').style.display = 'flex';
          // Handler for confirm
          document.getElementById('purchaseConfirmBtn').onclick = async function() {
            const token = localStorage.getItem("sessionToken");
            try {
              const res = await fetch(API_URL, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "x-session-token": token
                },
                body: JSON.stringify({ cart })
              });
              const data = await res.json();
              if (data.status === "ok") {
                // Add purchased items to purchased list (deep copy)
                cart.forEach(item => {
                  purchased.push({ ...item });
                });
                updatePurchasedDisplay();
                cart = [];
                updateCartDisplay();
              } else {
                showAlert("結帳失敗：" + (data.error || "未知錯誤"));
              }
            } catch (e) {
              showAlert("結帳失敗：伺服器錯誤");
            }
            document.getElementById('purchaseModal').style.display = 'none';
          };
          // Handler for cancel
          document.getElementById('purchaseCancelBtn').onclick = function() {
            document.getElementById('purchaseModal').style.display = 'none';
          };
        }
    /***** 你只需要改這一行 *****/
    const API_URL = "https://pos-v1-api-1077804657394.asia-east1.run.app"; // ← 改成你的
    /********************************/

    let sessionToken = localStorage.getItem("sessionToken");
    let cart = []; // 購物車陣列
    let allItems = []; // 所有商品
    let purchased = []; // 已購清單

    function showLogin() {
      document.getElementById("login").style.display = "flex";
      document.getElementById("app").style.display = "none";
    }

    function showApp() {
      document.getElementById("login").style.display = "none";
      document.getElementById("app").style.display = "flex";
    }

    async function login() {
      const pin = document.getElementById("pin").value;

      const res = await fetch(API_URL + "?login=1", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pin })
      });

      const data = await res.json();

      if (data.token) {
        localStorage.setItem("sessionToken", data.token);
        sessionToken = data.token;
        showApp();
        loadItems();
      } else {
        showAlert("PIN 錯誤");
      }
    }

    // Custom alert function
    function showAlert(message) {
      document.getElementById('alertMessage').textContent = message;
      document.getElementById('alertModal').style.display = 'flex';
      document.getElementById('alertOkBtn').onclick = function() {
        document.getElementById('alertModal').style.display = 'none';
      };
    }

    async function loadItems() {
      const token = localStorage.getItem("sessionToken");
      console.log("loadItems token =", token);

      // 6 個範例商品
      allItems = [
        { id: 1, name: "人生美式", price: 100 },
        { id: 2, name: "幸運拿鐵", price: 130 },
        { id: 3, name: "命運手沖", price: 130 },
        { id: 4, name: "大馬恐龍美祿", price: 120 },
        { id: 5, name: "貓掌冰磚咖啡", price: 200 }
      ];

      renderItems();

      // 可選：嘗試從 API 獲取商品列表
      try {
        const res = await fetch(API_URL, {
          headers: {
            "x-session-token": token
          }
        });

        const data = await res.json();
        
        // 如果 API 有回傳商品列表，則使用 API 數據
        if (data.items && Array.isArray(data.items)) {
          allItems = data.items;
          renderItems();
        }
      } catch (error) {
        console.error("Error loading items from API:", error);
      }
    }

    function renderItems() {
      const itemsGrid = document.getElementById("itemsGrid");
      itemsGrid.innerHTML = "";

      const items = allItems; // Show all items

      // Store temp note and amount for each item
      if (!window.itemNotes) window.itemNotes = {};
      if (!window.itemAmounts) window.itemAmounts = {};

      items.forEach(item => {
        // Row container for card and controls
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.flexDirection = "row";
        row.style.alignItems = "center";
        row.style.gap = "16px";
        row.style.marginBottom = "8px";

        // --- Item Card ---
        const card = document.createElement("div");
        card.className = "item-card";
        card.setAttribute("role", "button");
        card.tabIndex = 0;

        const img = document.createElement("img");
        img.src = "logo2b.png";
        img.alt = item.name;
        img.className = "item-image";

        const details = document.createElement("div");
        details.className = "item-details";
        details.innerHTML = `
          <div class="item-name">${item.name || "商品"}</div>
          <div class="item-price">$${item.price || 0}</div>
        `;

        // Purchase button (bigger)
        const btn = document.createElement("button");
        btn.className = "item-btn";
        btn.textContent = "購買";
        btn.style.fontSize = "20px";
        btn.style.padding = "12px 24px";
        btn.onclick = (e) => {
          e.stopPropagation();
          handleAdd();
        };

        card.style.display = "flex";
        card.style.flexDirection = "row";
        card.style.alignItems = "center";
        card.style.justifyContent = "space-between";

        card.appendChild(img);
        card.appendChild(details);
        card.appendChild(btn);

        // --- Controls (outside card, but next to it) ---
        if (window.itemAmounts[item.id] === undefined) window.itemAmounts[item.id] = item.price;
        if (window.itemNotes[item.id] === undefined) window.itemNotes[item.id] = "";

        const controlsBox = document.createElement("div");
        controlsBox.style.display = "flex";
        controlsBox.style.flexDirection = "column";
        controlsBox.style.alignItems = "flex-end";
        controlsBox.style.justifyContent = "center";
        controlsBox.style.gap = "12px";
        controlsBox.style.minWidth = "140px";
        controlsBox.style.maxWidth = "180px";
        controlsBox.style.background = "#1a1a2e";
        controlsBox.style.borderRadius = "8px";
        controlsBox.style.padding = "12px";
        controlsBox.style.border = "1px solid #1a2d4a";

        const noteInput = document.createElement("input");
        noteInput.type = "text";
        noteInput.placeholder = "備註";
        noteInput.value = window.itemNotes[item.id] || "";
        noteInput.className = "item-note-input";
        noteInput.oninput = (e) => {
          window.itemNotes[item.id] = e.target.value;
        };

        const amountRow = document.createElement("div");
        amountRow.style.display = "flex";
        amountRow.style.alignItems = "center";
        amountRow.style.justifyContent = "space-between";
        amountRow.style.gap = "4px";
        amountRow.style.background = "#1a1a2e";
        amountRow.style.border = "1.5px solid #D4AF37";
        amountRow.style.borderRadius = "6px";
        amountRow.style.padding = "4px 6px";
        amountRow.style.width = "100%";
        amountRow.style.boxSizing = "border-box";

        const minusBtn = document.createElement("button");
        minusBtn.textContent = "-5";
        minusBtn.className = "item-btn item-plus-btn";
        minusBtn.style.padding = "3px 5px";
        minusBtn.style.fontSize = "11px";
        minusBtn.style.marginLeft = "0px";
        minusBtn.style.background = "#D4AF37";
        minusBtn.style.color = "#0B1929";
        minusBtn.style.border = "none";
        minusBtn.style.borderRadius = "4px";
        minusBtn.style.cursor = "pointer";
        minusBtn.style.fontWeight = "bold";
        minusBtn.onclick = (e) => {
          e.stopPropagation();
          window.itemAmounts[item.id] = Math.max(0, (window.itemAmounts[item.id] || item.price) - 5);
          renderItems();
        };

        const amountInput = document.createElement("input");
        amountInput.type = "number";
        amountInput.className = "item-amount-input";
        amountInput.value = window.itemAmounts[item.id] || item.price;
        amountInput.min = 0;
        amountInput.style.width = "45px";
        amountInput.style.fontSize = "13px";
        amountInput.style.padding = "3px 2px";
        amountInput.style.borderRadius = "4px";
        amountInput.style.border = "1px solid #D4AF37";
        amountInput.style.background = "#0B1929";
        amountInput.style.color = "#D4AF37";
        amountInput.style.textAlign = "center";
        amountInput.oninput = (e) => {
          let val = parseInt(e.target.value);
          if (isNaN(val) || val < 0) val = 0;
          window.itemAmounts[item.id] = val;
        };

        const plusBtn = document.createElement("button");
        plusBtn.textContent = "+5";
        plusBtn.className = "item-btn item-plus-btn";
        plusBtn.style.padding = "3px 5px";
        plusBtn.style.fontSize = "11px";
        plusBtn.style.marginLeft = "0px";
        plusBtn.style.background = "#D4AF37";
        plusBtn.style.color = "#0B1929";
        plusBtn.style.border = "none";
        plusBtn.style.borderRadius = "4px";
        plusBtn.style.cursor = "pointer";
        plusBtn.style.fontWeight = "bold";
        plusBtn.onclick = (e) => {
          e.stopPropagation();
          window.itemAmounts[item.id] = (window.itemAmounts[item.id] || item.price) + 5;
          renderItems();
        };

        amountRow.appendChild(minusBtn);
        
        // Add $ symbol label
        const dollarLabel = document.createElement("span");
        dollarLabel.textContent = "$";
        dollarLabel.style.color = "#D4AF37";
        dollarLabel.style.fontSize = "12px";
        dollarLabel.style.fontWeight = "bold";
        dollarLabel.style.marginRight = "2px";
        amountRow.appendChild(dollarLabel);
        
        amountRow.appendChild(amountInput);
        amountRow.appendChild(plusBtn);

        controlsBox.appendChild(noteInput);
        controlsBox.appendChild(amountRow);

        // Card click: add to cart with note and temp amount
        function handleAdd() {
          addToCart({
            name: item.name,
            price: window.itemAmounts[item.id] || item.price,
            id: item.id,
            note: window.itemNotes[item.id] || ""
          });
          // Reset note and amount after purchase
          window.itemNotes[item.id] = "";
          window.itemAmounts[item.id] = item.price;
          renderItems();
        }
        card.addEventListener("click", (e) => {
          if (e.target === card || e.target === img || e.target === details) {
            handleAdd();
          }
        });
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            handleAdd();
          }
        });

        row.appendChild(card);
        row.appendChild(controlsBox);
        itemsGrid.appendChild(row);
      });
    }

    function addToCart(item) {
      const existingItem = cart.find(c => c.id === item.id && c.note === (item.note || "") && c.price === item.price);

      if (existingItem) {
        existingItem.qty += 1;
      } else {
        cart.push({
          id: item.id,
          name: item.name,
          price: item.price,
          qty: 1,
          note: item.note || ""
        });
      }

      updateCartDisplay();
    }

    function removeFromCart(itemId) {
      // Support note and price as keys
      if (arguments.length > 1) {
        const note = arguments[1] || "";
        const price = arguments[2];
        cart = cart.filter(item => !(item.id === itemId && item.note === note && item.price === price));
      } else {
        cart = cart.filter(item => item.id !== itemId);
      }
      updateCartDisplay();
    }

    function updateCartDisplay() {
      const cartItems = document.getElementById("cartItems");
      const totalAmount = document.getElementById("totalAmount");

      cartItems.innerHTML = "";

      let total = 0;

      cart.forEach(item => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;

        const cartItem = document.createElement("div");
        cartItem.className = "cart-item";

        const nameSpan = document.createElement("span");
        nameSpan.className = "cart-item-name";
        nameSpan.textContent = item.name;

        // Show note (if any)
        const noteSpan = document.createElement("span");
        noteSpan.className = "cart-item-note";
        noteSpan.style.fontSize = "13px";
        noteSpan.style.color = "#999";
        noteSpan.style.marginLeft = "8px";
        noteSpan.textContent = item.note ? `(${item.note})` : "";

        // Show star if temp amount is used (not original price)
        const tempAmountSpan = document.createElement("span");
        tempAmountSpan.className = "cart-item-temp-amount";
        tempAmountSpan.style.fontSize = "18px";
        tempAmountSpan.style.color = "#D4AF37";
        tempAmountSpan.style.marginLeft = "8px";
        tempAmountSpan.textContent = (item.price !== (allItems.find(i => i.id === item.id)?.price)) ? "★" : "";

        // Show quantity as plain text (not editable)
        const qtyContainer = document.createElement("div");
        qtyContainer.className = "cart-item-qty-container";
        qtyContainer.style.fontSize = "16px";
        qtyContainer.style.fontWeight = "bold";
        qtyContainer.style.color = "#D4AF37";
        qtyContainer.textContent = `x${item.qty}`;

        const priceSpan = document.createElement("span");
        priceSpan.className = "cart-item-price";
        priceSpan.textContent = "$" + itemTotal;

        const removeBtn = document.createElement("button");
        removeBtn.className = "cart-item-remove";
        removeBtn.textContent = "刪除";
        removeBtn.onclick = () => removeFromCart(item.id, item.note, item.price);

        cartItem.appendChild(nameSpan);
        cartItem.appendChild(noteSpan);
        cartItem.appendChild(tempAmountSpan);
        cartItem.appendChild(qtyContainer);
        cartItem.appendChild(priceSpan);
        cartItem.appendChild(removeBtn);
        cartItems.appendChild(cartItem);
      });

      totalAmount.textContent = "$" + total;
    }

    function updateItemQty(itemId, newQty) {
      // Support note and price as keys
      if (arguments.length > 2) {
        const note = arguments[2] || "";
        const price = arguments[3];
        const item = cart.find(c => c.id === itemId && c.note === note && c.price === price);
        if (item && newQty > 0) {
          item.qty = newQty;
          updateCartDisplay();
        }
      } else {
        const item = cart.find(c => c.id === itemId);
        if (item && newQty > 0) {
          item.qty = newQty;
          updateCartDisplay();
        }
      }
    }

    function clearCart() {
      // Show custom modal instead of browser confirm
      document.getElementById('clearCartModal').style.display = 'flex';
      // Handler for confirm
      document.getElementById('clearCartConfirmBtn').onclick = function() {
        cart = [];
        // Do NOT clear purchased!
        if (window.itemNotes) {
          Object.keys(window.itemNotes).forEach(id => window.itemNotes[id] = "");
        }
        if (window.itemAmounts && allItems) {
          allItems.forEach(item => {
            window.itemAmounts[item.id] = item.price;
          });
        }
        updateCartDisplay();
        renderItems();
        document.getElementById('clearCartModal').style.display = 'none';
      };
      // Handler for cancel
      document.getElementById('clearCartCancelBtn').onclick = function() {
        document.getElementById('clearCartModal').style.display = 'none';
      };
    }

    function updatePurchasedDisplay() {
      const purchasedList = document.getElementById('purchasedList');
      purchasedList.innerHTML = '';
      purchased.forEach((item, idx) => {
        const el = document.createElement('div');
        el.className = 'purchased-item';
        el.innerHTML = `
          <span>${item.name} x${item.qty} <span style="color:#D4AF37;">$${item.price * item.qty}</span> ${item.note ? `<span style='color:#999;font-size:13px;'>(${item.note})</span>` : ''}</span>
          <button class="cross-btn" title="完成/刪除" onclick="removePurchased(${idx})">×</button>
        `;
        purchasedList.appendChild(el);
      });
    }

    // Remove purchased item by index
    function removePurchased(idx) {
      purchased.splice(idx, 1);
      updatePurchasedDisplay();
    }

    function logout() {
      localStorage.removeItem("sessionToken");
      sessionToken = null;
      cart = [];
      showLogin();
      document.getElementById("pin").value = "";
    }

    // 頁面一開啟自動判斷是否已登入
    const token = localStorage.getItem("sessionToken");

    // Expose removePurchased globally for inline onclick
    window.removePurchased = removePurchased;

    if (token) {
      showApp();
      loadItems();
      updatePurchasedDisplay();
    } else {
      showLogin();
    }

  </script>

</body>
</html>
